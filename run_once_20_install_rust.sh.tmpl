#!/usr/bin/env bash
set -euo pipefail

# Installs rustup + pins the Rust toolchain version from versions.toml (per-user).

VERSIONS_FILE="{{ .chezmoi.sourceDir }}/versions.toml"
RUST_TOOLCHAIN="$(awk -F'"' '/^rust_toolchain/ {print $2}' "$VERSIONS_FILE")"

if command -v rustup >/dev/null 2>&1; then
  echo "rustup already installed."
else
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --no-modify-path
fi

# Make rustup/cargo available in this script run.
# (The user's zprofile will handle it for future shells.)
export PATH="$HOME/.cargo/bin:$PATH"

rustup toolchain install "$RUST_TOOLCHAIN"
rustup default "$RUST_TOOLCHAIN"
rustup component add clippy rustfmt
