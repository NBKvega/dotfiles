#!/usr/bin/env bash
set -euo pipefail

# Installs tools that are either not available in apt (or too old), or that you
# want consistent versions for across machines.

VERSIONS_FILE="{{ .chezmoi.sourceDir }}/versions.toml"

get_toml_version() {
  local key="$1"
  awk -F'"' -v k="$key" '$1 ~ ("^"k" *=") {print $2}' "$VERSIONS_FILE"
}

OS="$(uname -s)"
ARCH="$(uname -m)"

# Map uname -m to common release asset naming
case "$ARCH" in
  x86_64|amd64) ARCH_GNU="x86_64" ;;
  aarch64|arm64) ARCH_GNU="aarch64" ;;
  armv7l) ARCH_GNU="armv7" ;;
  *) echo "ERROR: Unsupported arch: $ARCH" ; exit 1 ;;
esac

mkdir -p "$HOME/.local/bin"

install_github_release() {
  local repo="$1"            # e.g. helix-editor/helix
  local version="$2"         # tag
  local asset="$3"           # asset filename
  local binpath_in_tar="$4"  # path to binary inside archive
  local outname="$5"         # name in ~/.local/bin

  local url="https://github.com/${repo}/releases/download/${version}/${asset}"
  local tmpdir
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' RETURN

  echo "Downloading: $url"
  curl -fsSL "$url" -o "$tmpdir/pkg"
  tar -xf "$tmpdir/pkg" -C "$tmpdir"
  install -m 0755 "$tmpdir/$binpath_in_tar" "$HOME/.local/bin/$outname"
}

if [[ "$OS" == "Linux" ]]; then
  # Helix
  HELIX_VER="$(get_toml_version helix)"
  install_github_release \
    "helix-editor/helix" \
    "${HELIX_VER}" \
    "helix-${HELIX_VER}-${ARCH_GNU}-linux.tar.xz" \
    "helix-${HELIX_VER}-${ARCH_GNU}-linux/hx" \
    "hx"

  # Zellij (tag "vX.Y.Z")
  ZELLIJ_VER="$(get_toml_version zellij)"
  install_github_release \
    "zellij-org/zellij" \
    "v${ZELLIJ_VER}" \
    "zellij-${ARCH_GNU}-unknown-linux-musl.tar.gz" \
    "zellij" \
    "zellij"

  # Starship (tag "vX.Y.Z")
  STARSHIP_VER="$(get_toml_version starship)"
  install_github_release \
    "starship/starship" \
    "v${STARSHIP_VER}" \
    "starship-${ARCH_GNU}-unknown-linux-musl.tar.gz" \
    "starship" \
    "starship"

  # Typst (tag "vX.Y.Z")
  TYPST_VER="$(get_toml_version typst)"
  install_github_release \
    "typst/typst" \
    "v${TYPST_VER}" \
    "typst-${TYPST_VER}-${ARCH_GNU}-unknown-linux-musl.tar.xz" \
    "typst-${TYPST_VER}-${ARCH_GNU}-unknown-linux-musl/typst" \
    "typst"

  # Fonts (user-local): MesloLGS Nerd Font
  NERD_VER="$(get_toml_version nerd_fonts)"
  FONT_DIR="$HOME/.local/share/fonts"
  mkdir -p "$FONT_DIR"
  tmpdir="$(mktemp -d)"
  trap 'rm -rf "$tmpdir"' RETURN

  curl -fsSL "https://github.com/ryanoasis/nerd-fonts/releases/download/${NERD_VER}/Meslo.zip" -o "$tmpdir/Meslo.zip"
  (cd "$tmpdir" && unzip -q Meslo.zip -d "$FONT_DIR")
  fc-cache -f "$FONT_DIR" >/dev/null 2>&1 || true

elif [[ "$OS" == "Darwin" ]]; then
  if ! command -v brew >/dev/null 2>&1; then
    echo "ERROR: brew not found. Run base installer first."
    exit 1
  fi

  brew update
  brew install starship zellij helix typst magic-wormhole zoxide eza btop nmap rsync wget llvm
  brew install zsh-autosuggestions zsh-syntax-highlighting
  brew install --cask font-iosevka font-meslo-lg-nerd-font

else
  echo "ERROR: Unsupported OS: $OS"
  exit 1
fi
